# MODAX MQTT Broker - Production Configuration
# This configuration enables authentication and TLS for production deployment
# Place in /etc/mosquitto/conf.d/modax.conf or use with: mosquitto -c mosquitto-prod.conf

# ============================================================================
# LISTENER CONFIGURATION
# ============================================================================

# TLS Listener (Primary)
listener 8883
protocol mqtt
cafile /etc/mosquitto/ca_certificates/ca.crt
certfile /etc/mosquitto/certs/server.crt
keyfile /etc/mosquitto/certs/server.key
require_certificate false  # Set to true for mutual TLS
use_identity_as_username false

# Optional: Plain listener for internal network only
# listener 1883 127.0.0.1
# protocol mqtt

# ============================================================================
# AUTHENTICATION & AUTHORIZATION
# ============================================================================

# Disable anonymous access
allow_anonymous false

# Password file (create with: mosquitto_passwd -c /etc/mosquitto/passwd username)
password_file /etc/mosquitto/passwd

# ACL file for topic-based access control
# acl_file /etc/mosquitto/acl

# ============================================================================
# QUEUE SETTINGS
# ============================================================================

max_queued_messages 2000
max_inflight_messages 50
max_queued_bytes 10485760  # 10MB

# Message size limit (100KB default)
message_size_limit 102400

# ============================================================================
# PERSISTENCE
# ============================================================================

persistence true
persistence_location /var/lib/mosquitto/
autosave_interval 300  # 5 minutes
autosave_on_changes false

# Persistence database file
persistence_file mosquitto.db

# ============================================================================
# LOGGING
# ============================================================================

log_dest file /var/log/mosquitto/mosquitto.log
log_dest stdout

# Log types: error, warning, notice, information, subscribe, unsubscribe
log_type error
log_type warning
log_type notice
log_type information

log_timestamp true
log_timestamp_format %Y-%m-%d %H:%M:%S

# Connection messages for debugging (disable in production for performance)
connection_messages true

# ============================================================================
# CONNECTION SETTINGS
# ============================================================================

# Maximum number of concurrent connections (-1 = unlimited)
max_connections -1

# Disconnect clients after 300 seconds of inactivity
persistent_client_expiration 1h

# Keepalive timeout
max_keepalive 65535

# ============================================================================
# BRIDGE CONFIGURATION (for remote broker sync)
# ============================================================================
# Uncomment and configure if you need to bridge to another broker
# connection bridge-01
# address remote-broker.example.com:8883
# remote_username bridge-user
# remote_password bridge-password
# topic # both 0 modax/ remote/

# ============================================================================
# SECURITY SETTINGS
# ============================================================================

# Upgrade QoS for subscriptions
upgrade_outgoing_qos false

# Allow retained messages
retain_available true

# Allow last will and testament
allow_duplicate_messages false

# ============================================================================
# NOTES
# ============================================================================
# 1. Generate certificates using:
#    - OpenSSL for self-signed: openssl req -new -x509 -days 365 -extensions v3_ca -keyout ca.key -out ca.crt
#    - Let's Encrypt for production: certbot certonly --standalone -d mqtt.example.com
#
# 2. Create password file:
#    mosquitto_passwd -c /etc/mosquitto/passwd control-layer
#    mosquitto_passwd /etc/mosquitto/passwd ai-layer
#    mosquitto_passwd /etc/mosquitto/passwd esp32-device-01
#
# 3. Create ACL file (/etc/mosquitto/acl) example:
#    user control-layer
#    topic readwrite modax/#
#    
#    user ai-layer
#    topic read modax/sensor/data
#    topic write modax/ai/analysis
#    
#    user esp32-device-01
#    topic write modax/sensor/data
#    topic write modax/sensor/safety
#    topic read modax/control/commands
#
# 4. Test configuration:
#    mosquitto -c /etc/mosquitto/conf.d/modax.conf -v
#
# 5. Connect with TLS:
#    mosquitto_sub -h localhost -p 8883 --cafile ca.crt -u control-layer -P password -t "modax/#"
