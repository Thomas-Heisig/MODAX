# Docker Compose for MODAX System - Production Configuration
# This configuration includes:
# - MQTT authentication and TLS
# - API authentication
# - Monitoring stack (Prometheus, Grafana, Loki)
# - Production-ready settings

version: '3.8'

services:
  # ============================================================================
  # MQTT Broker with Authentication and TLS
  # ============================================================================
  mqtt:
    image: eclipse-mosquitto:2.0
    container_name: modax-mqtt-prod
    ports:
      - "8883:8883"  # TLS port
      - "1883:1883"  # Plain port (optional, for internal network only)
    volumes:
      - ./config/mosquitto-prod.conf:/mosquitto/config/mosquitto.conf
      - ./config/mosquitto-acl.example:/mosquitto/config/acl:ro
      - ./certs/mqtt:/mosquitto/certs:ro
      - ./certs/ca:/mosquitto/ca_certificates:ro
      - mqtt-passwd:/mosquitto/passwd:ro
      - mqtt-data:/mosquitto/data
      - mqtt-logs:/mosquitto/log
    environment:
      - TZ=UTC
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-t", "$$SYS/#", "-C", "1", "-i", "healthcheck", "-W", "3"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - modax-network

  # ============================================================================
  # Control Layer with Authentication
  # ============================================================================
  control-layer:
    build:
      context: ./python-control-layer
      dockerfile: Dockerfile
    container_name: modax-control-layer-prod
    ports:
      - "8000:8000"
    env_file:
      - ./config/control-layer-security.env.example
    environment:
      # MQTT Configuration
      - MQTT_BROKER_HOST=mqtt
      - MQTT_BROKER_PORT=8883
      - MQTT_USE_TLS=true
      - MQTT_CA_CERTS=/app/certs/ca/ca.crt
      - MQTT_USERNAME=${MQTT_CONTROL_USERNAME:-control-layer}
      - MQTT_PASSWORD=${MQTT_CONTROL_PASSWORD}
      
      # API Configuration
      - API_HOST=0.0.0.0
      - API_PORT=8000
      - API_KEY_ENABLED=true
      - HMI_API_KEY=${HMI_API_KEY}
      - MONITORING_API_KEY=${MONITORING_API_KEY}
      - ADMIN_API_KEY=${ADMIN_API_KEY}
      
      # AI Layer Integration
      - AI_LAYER_URL=http://ai-layer:8001/api/v1/analyze
      - AI_ENABLED=true
      - AI_LAYER_TIMEOUT=10
      
      # Logging
      - USE_JSON_LOGS=true
      
      # Rate Limiting
      - RATE_LIMIT_ENABLED=true
      - RATE_LIMIT_DEFAULT=100/minute
      
      # CORS (restrict in production)
      - CORS_ORIGINS=https://hmi.example.com,https://dashboard.example.com
      - CORS_ALLOW_CREDENTIALS=true
      - CORS_ALLOW_METHODS=GET,POST,PUT,DELETE
      - CORS_ALLOW_HEADERS=Content-Type,X-API-Key
      
      # Database (TimescaleDB)
      - DB_ENABLED=true
      - DB_HOST=timescaledb
      - DB_PORT=5432
      - DB_NAME=modax
      - DB_USER=${DB_USER:-modax}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_POOL_SIZE=10
      - DB_MAX_OVERFLOW=20
    volumes:
      - ./certs/ca:/app/certs/ca:ro
    depends_on:
      - mqtt
      - ai-layer
      - timescaledb
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - modax-network

  # ============================================================================
  # AI Layer with Authentication
  # ============================================================================
  ai-layer:
    build:
      context: ./python-ai-layer
      dockerfile: Dockerfile
    container_name: modax-ai-layer-prod
    ports:
      - "8001:8001"
    environment:
      - AI_HOST=0.0.0.0
      - AI_PORT=8001
      - USE_JSON_LOGS=true
      - RATE_LIMIT_ENABLED=true
      - RATE_LIMIT_DEFAULT=100/minute
      - CORS_ORIGINS=https://hmi.example.com,https://dashboard.example.com
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - modax-network

  # ============================================================================
  # TimescaleDB for Historical Data
  # ============================================================================
  timescaledb:
    image: timescale/timescaledb:latest-pg15
    container_name: modax-timescaledb
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=modax
      - POSTGRES_USER=${DB_USER:-modax}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_INITDB_ARGS=-U ${DB_USER:-modax}
    volumes:
      - timescaledb-data:/var/lib/postgresql/data
      - ./config/timescaledb-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-modax}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - modax-network

  # ============================================================================
  # Prometheus - Metrics Collection
  # ============================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: modax-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./config/prometheus-rules.yml:/etc/prometheus/rules.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--web.enable-lifecycle'
    restart: unless-stopped
    networks:
      - modax-network

  # ============================================================================
  # Grafana - Visualization
  # ============================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: modax-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_INSTALL_PLUGINS=grafana-clock-panel
      - GF_SERVER_ROOT_URL=https://grafana.example.com
      - GF_DATABASE_TYPE=postgres
      - GF_DATABASE_HOST=timescaledb:5432
      - GF_DATABASE_NAME=grafana
      - GF_DATABASE_USER=${DB_USER:-modax}
      - GF_DATABASE_PASSWORD=${DB_PASSWORD}
    volumes:
      - grafana-data:/var/lib/grafana
      - ./config/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./config/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      - prometheus
      - timescaledb
    restart: unless-stopped
    networks:
      - modax-network

  # ============================================================================
  # Loki - Log Aggregation
  # ============================================================================
  loki:
    image: grafana/loki:latest
    container_name: modax-loki
    ports:
      - "3100:3100"
    volumes:
      - ./config/loki-config.yml:/etc/loki/local-config.yaml:ro
      - loki-data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    restart: unless-stopped
    networks:
      - modax-network

  # ============================================================================
  # Promtail - Log Shipping to Loki
  # ============================================================================
  promtail:
    image: grafana/promtail:latest
    container_name: modax-promtail
    volumes:
      - ./config/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki
    restart: unless-stopped
    networks:
      - modax-network

  # ============================================================================
  # Alertmanager - Alert Routing
  # ============================================================================
  alertmanager:
    image: prom/alertmanager:latest
    container_name: modax-alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./config/alertmanager.yml:/etc/alertmanager/config.yml:ro
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/config.yml'
      - '--storage.path=/alertmanager'
    restart: unless-stopped
    networks:
      - modax-network

volumes:
  mqtt-data:
  mqtt-logs:
  mqtt-passwd:
  timescaledb-data:
  prometheus-data:
  grafana-data:
  loki-data:
  alertmanager-data:

networks:
  modax-network:
    name: modax-prod-network
    driver: bridge
